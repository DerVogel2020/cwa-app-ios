//
// ðŸ¦  Corona-Warn-App
//

import XCTest
@testable import HealthCertificateToolkit

class DCCSignatureVerificationTests: XCTestCase {

    func test_Success_For_TestCertificate() throws {
        let dscListData = try XCTUnwrap(dscListJSONString.data(using: .utf8))
        let dscList = try JSONDecoder().decode([DCCSigningCertificate].self, from: dscListData)

        for testData in dcc {
            guard let certificateBase45 = testData["certificate"] as? Base45,
                  let expectedResult = testData["result"] as? TestResult else {
                XCTFail("Could not load test data.")
                return
            }

            let result = DCCSignatureVerification().verify(certificate: certificateBase45, with: dscList, and: Date())
            switch (result, expectedResult) {
            case (.success, .success) :
                break
            case (.failure(let error), .failure(let expectedError)):
                XCTAssertEqual(error, expectedError)
            default:
                XCTFail("Result of verification not expected.")
            }
        }
    }

    enum TestResult {
        case success
        case failure(DCCSignatureVerificationError)
    }

    let dcc = [
        // generated with: --cert-id forRCsWithOID, Extended Key Usage: RC, Certificate Type: TC
        [
            "certificate": "HC1:6BFX AS7OAJ0DR3*SEDAHK OR597KDJPS%$VV9Q0Z5:5FU.K9*EN-HN0O.%BXK236J$9SJ-O XG6AHIV9B%4J12%SM/89R0DG+0J OIEO/O2:IH6GU*5KYZQ6NMO2EBM4598/3V 56:+EXAJ$664*4PYA-569DSJIELCG$WALR2L/LKR6R1Q7W5V*1668UVO.SS-SD/4O/GGD/D.6SJ$H2THXUBEUTU GHC5BZMI6MC5L0E39 7Y.GRHJ6B2%D0ZGQGN9DO9%Q8$GI 00VT9HEFEJ4%OIVG1 +E2NOXS9Y.J4OUIH25K18T52%KO+SEF2STDSN72HHN32F-G*PG8AE%V0N/S:H71EATSH2Q62V5$.6:2GCKPC+1NGBFYR M0IH2NAV:294F5%R2QXBJNB:XGF8RW9PX-GXS7VMV2V60GIGTJFO5B1L5NHIYB+I0Y+MS*V VH7JATKK254E3VM*PFFL0T5P5L P4RK5ALU1 DF+6DD2N2855ON R1:QISOG2SLCE20PSEL.5CJVP16KI:0G$VPAC0NDQZVCTF QB//N 1UQ1F+0FE4P.PL91F5CV4WLVM15/TASC:+0+G5/1",
            "result": TestResult.failure(.HC_DSC_OID_MISMATCH_RC)
        ],
        // generated with: --cert-id forRCsWithOID, Extended Key Usage: RC, Certificate Type: VC
        [
            "certificate": "HC1:6BFOXN*TS0BI$ZD8UHB0O. BQODJZ3G*H:XI1RO4.S-OP3/I+8D.X4SSAHSC41AF/8X*G-O9UVPQRHIY1VS1NQ1 WUQRELS4 CT1HFB+2$CT%*4J1TYXV33L36DJZC8ALD-ILHFU*02$V+*431TP%K4J7PVN-TV+*4.$S6ZCY73X63RE07IKMJC7ZSA KZ*U0I1-I0*OC6H0/VMNPM Q5TM8*N9 I2.8QEC5VBK4JOL/5BINDTMXHM2X6V27T96IABUA76W9$59QP17VKQQEL+9.IAHLCV5GVWN.FKBFQYPCWQ9C KXU70%K8S2C K/F25ZA+786%P4W1NTICZUL0K6PP+ 5-PP:G9XF5-JU04AXIQM P7-5AQ5SW5PK95%L//6JWE/.Q1002*F1O35$FFYB:%BL.JDXBE:R60S2W35J0%YB5Z9D:RAWH/S3Q/N9/A1.C$QV9N42/V.SF5:LR8SD%S61W5OD1RQ8ZEC%QLOIHSFCVFP2ND7TUVV-YOZF1TM3:NV**UDWNKBVK6M$7N2VVX/UYCKZ40C5R$3",
            "result": TestResult.failure(.HC_DSC_OID_MISMATCH_RC),
        ],
        // generated with: --cert-id forRCsWithOID, Extended Key Usage: RC, Certificate Type: RC
        [
            "certificate": "HC1:6BFOXN*TS0BI$ZD8UHB0O. BQODJZ3T.H8EMAD61:OLX87PT8PP/+6BV8LF6AN9I6T5XH4PIQJAZGA2:UG%U:PI/E2$4J /K*ZCI1D3ZCB6JC4T%*4J1TZF7V5TW-28AL**IVH7KP06$0ADF5A76ALD-IAG7-TVV+05AL5:4A93JKBZQT-EJMD3DP4OW6G0A+E93ZM$96PZ6+Q6X46.G9CPPNF67J6QW6OVQEOMPK95-0.74C9D-7A%IA%DA9MGF:F81HS1D7HQBPIAOI5XIXCLDQE9Q8C KUGAACQH99CEQN95ZTM+CSUHQN%A400H%UBT16Y5+Z9Q+6MWTX77WI3*J3 E7HW8PL33+GMSVHN7323/Z84SJ709UP5$AH8LN-7V5PTJNL1I18:DY11R%6YJPGX6*EQ%1TCP8H*P4WJ8DB+5GL.E203$7OOWRX3M7.5821/HSCL6N0E-X8ZMNS+RYYV85K/00ADW34",
            "result": TestResult.success,
        ]
    ]

    // swiftlint:disable line_length
    let dscListJSONString =
        """
        [{\"kid\":\"6LVeJLKcq3s=\",\"data\":\"MIICCzCCAbKgAwIBAgIJANGHZ6QEo1fxMAkGByqGSM49BAEwYjELMAkGA1UEBhMCREUxCzAJBgNVBAgMAkJXMREwDwYDVQQHDAhXYWxsZG9yZjEPMA0GA1UECgwGU0FQIFNFMRAwDgYDVQQLDAdDV0EgQ0xJMRAwDgYDVQQDDAdjd2EtY2xpMB4XDTIxMDcwOTA3NTM1NFoXDTMxMDcwNzA3NTM1NFowYjELMAkGA1UEBhMCREUxCzAJBgNVBAgMAkJXMREwDwYDVQQHDAhXYWxsZG9yZjEPMA0GA1UECgwGU0FQIFNFMRAwDgYDVQQLDAdDV0EgQ0xJMRAwDgYDVQQDDAdjd2EtY2xpMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAENdTl++tlkNx2ICopt9aGqcyL0Tu38JcRSlNuWmSZcFPbG2dP0+YZd7oO\\/3ZU4Puvfh\\/VUuK3wRHAvOmzYuZPvKNSMFAwDgYDVR0PAQH\\/BAQDAgeAMB0GA1UdDgQWBBROq1nZRFqFSLNDTR7bwMR5KrZWHjAfBgNVHSMEGDAWgBS\\/hghB7Sqx\\/Z49r2OWQiJCveyCOTAJBgcqhkjOPQQBA0gAMEUCICpHFWcoIspWJo06Z4sEj\\/474Aun27hjEExVkAGzBGSfAiEAs7EXEMDikn6srQ7QPgHDtAqmLGSk5T2UZ9F0nQwdOoo=\"},{\"kid\":\"qslgaOBZviM=\",\"data\":\"MIIB7DCCAZSgAwIBAgIJANGHZ6QEo1fyMAkGByqGSM49BAEwYjELMAkGA1UEBhMCREUxCzAJBgNVBAgMAkJXMREwDwYDVQQHDAhXYWxsZG9yZjEPMA0GA1UECgwGU0FQIFNFMRAwDgYDVQQLDAdDV0EgQ0xJMRAwDgYDVQQDDAdjd2EtY2xpMB4XDTIxMDcwOTA3NTM1NFoXDTMxMDcwNzA3NTM1NFowYjELMAkGA1UEBhMCREUxCzAJBgNVBAgMAkJXMREwDwYDVQQHDAhXYWxsZG9yZjEPMA0GA1UECgwGU0FQIFNFMRAwDgYDVQQLDAdDV0EgQ0xJMRAwDgYDVQQDDAdjd2EtY2xpMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEJvYEgB18GARmRHu3kp5FsB9LluOmue6Y2p7gaKgScJXFXjsISfY49KLs\\/PJRxiuAmVWy0q6+Lac829zBJnOfXqM0MDIwMAYDVR0lBCkwJwYLKwYBBAGON49lAQEGCysGAQQBjjePZQECBgsrBgEEAY43j2UBAzAJBgcqhkjOPQQBA0cAMEQCIFuaCEw8wT0oARgHobhtOoADUb3l\\/H0GJ5FXFGtuo3GwAiBbxCa3Q4HLLLHPddNlYoa+359chVgDCCoIG1IlAbWt3A==\"},{\"kid\":\"ZuMKxY6pQr8=\",\"data\":\"MIIB8DCCAZegAwIBAgIJANGHZ6QEo1fzMAkGByqGSM49BAEwYjELMAkGA1UEBhMCREUxCzAJBgNVBAgMAkJXMREwDwYDVQQHDAhXYWxsZG9yZjEPMA0GA1UECgwGU0FQIFNFMRAwDgYDVQQLDAdDV0EgQ0xJMRAwDgYDVQQDDAdjd2EtY2xpMB4XDTIxMDcwOTA3NTM1NFoXDTMxMDcwNzA3NTM1NFowYjELMAkGA1UEBhMCREUxCzAJBgNVBAgMAkJXMREwDwYDVQQHDAhXYWxsZG9yZjEPMA0GA1UECgwGU0FQIFNFMRAwDgYDVQQLDAdDV0EgQ0xJMRAwDgYDVQQDDAdjd2EtY2xpMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAER5\\/DPdmNf7+vr+hi7mniXJK2GYPEonCbm01zV8PZfZwJFYwixkWtfkD657NrEIgp\\/\\/xbrER\\/UYzmDhzl0k4oO6M3MDUwMwYDVR0lBCwwKgYMKwYBBAEAjjePZQEBBgwrBgEEAQCON49lAQIGDCsGAQQBAI43j2UBAzAJBgcqhkjOPQQBA0gAMEUCIFLRZGF811sKVxNTjcEdHl7\\/dU5rK3VdGDRjeTiPW0znAiEAm4XVyipg3GVdoz+weCmOr2QYBLcHlF8KQe7MMnWQcKQ=\"},{\"kid\":\"ACkfCcHlSWY=\",\"data\":\"MIIB0jCCAXqgAwIBAgIJANGHZ6QEo1f2MAkGByqGSM49BAEwYjELMAkGA1UEBhMCREUxCzAJBgNVBAgMAkJXMREwDwYDVQQHDAhXYWxsZG9yZjEPMA0GA1UECgwGU0FQIFNFMRAwDgYDVQQLDAdDV0EgQ0xJMRAwDgYDVQQDDAdjd2EtY2xpMB4XDTIxMDcwOTA3NTM1NFoXDTMxMDcwNzA3NTM1NFowYjELMAkGA1UEBhMCREUxCzAJBgNVBAgMAkJXMREwDwYDVQQHDAhXYWxsZG9yZjEPMA0GA1UECgwGU0FQIFNFMRAwDgYDVQQLDAdDV0EgQ0xJMRAwDgYDVQQDDAdjd2EtY2xpMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEiKleLmeU4i6alHoxRlrrj\\/BxVwbFWW3qavAli5qvUegMuNk3\\/Y6lcgoJZ4HhztBwoKeLAaoi2DlHT3hoMf\\/DM6MaMBgwFgYDVR0lBA8wDQYLKwYBBAGON49lAQIwCQYHKoZIzj0EAQNHADBEAiB697w8TCyiSnenwfTpJgqB1c3+PiH5xa3FzhS6nItUAwIgTItpSG2e9eJzTuc40vJ0uj\\/LgzvqAe0yzFOmvS5zGYU=\"},{\"kid\":\"LnWaCCrE\\/nw=\",\"data\":\"MIIB1DCCAXugAwIBAgIJANGHZ6QEo1f3MAkGByqGSM49BAEwYjELMAkGA1UEBhMCREUxCzAJBgNVBAgMAkJXMREwDwYDVQQHDAhXYWxsZG9yZjEPMA0GA1UECgwGU0FQIFNFMRAwDgYDVQQLDAdDV0EgQ0xJMRAwDgYDVQQDDAdjd2EtY2xpMB4XDTIxMDcwOTA3NTM1NFoXDTMxMDcwNzA3NTM1NFowYjELMAkGA1UEBhMCREUxCzAJBgNVBAgMAkJXMREwDwYDVQQHDAhXYWxsZG9yZjEPMA0GA1UECgwGU0FQIFNFMRAwDgYDVQQLDAdDV0EgQ0xJMRAwDgYDVQQDDAdjd2EtY2xpMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE2FFYbm7R+V9OVwYZgD0vY+GQxvnPAwDqxwUq+0vo38QmLzsFdO8WxA0L3aKFiv37sqgh806r6U++03EpIXL0yaMbMBkwFwYDVR0lBBAwDgYMKwYBBAEAjjePZQECMAkGByqGSM49BAEDSAAwRQIhALD9IOuFdNKGJ8bRsBad0mqEeF9E1tNKsaY5RrDlDEo1AiArmRd7xpQDxC8lVd3FiThHKGbD4pRkXAIksI5sVpJMiw==\"},{\"kid\":\"U5lI1XIimH0=\",\"data\":\"MIIB0zCCAXqgAwIBAgIJANGHZ6QEo1f0MAkGByqGSM49BAEwYjELMAkGA1UEBhMCREUxCzAJBgNVBAgMAkJXMREwDwYDVQQHDAhXYWxsZG9yZjEPMA0GA1UECgwGU0FQIFNFMRAwDgYDVQQLDAdDV0EgQ0xJMRAwDgYDVQQDDAdjd2EtY2xpMB4XDTIxMDcwOTA3NTM1NFoXDTMxMDcwNzA3NTM1NFowYjELMAkGA1UEBhMCREUxCzAJBgNVBAgMAkJXMREwDwYDVQQHDAhXYWxsZG9yZjEPMA0GA1UECgwGU0FQIFNFMRAwDgYDVQQLDAdDV0EgQ0xJMRAwDgYDVQQDDAdjd2EtY2xpMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEJp7Uh2EmHYQ4O\\/WzAa4iCDE8Nb5ZeHGl6iYwDHYXG65Qb+DD7SpcOW1o5\\/HfV2EZLqr5GmV6N6sxK\\/IPmB+aSqMaMBgwFgYDVR0lBA8wDQYLKwYBBAGON49lAQEwCQYHKoZIzj0EAQNIADBFAiEAlFVmXEXrZEtXl3GWJgyfHSV9Dhv8TLtUSOwJdRhya4ECIEI+BN\\/Bpmvwfat14q9nmt0Su\\/Y6AForl5T0aQB2ir9A\"},{\"kid\":\"u9LSjm6zhNM=\",\"data\":\"MIIB0zCCAXugAwIBAgIJANGHZ6QEo1f1MAkGByqGSM49BAEwYjELMAkGA1UEBhMCREUxCzAJBgNVBAgMAkJXMREwDwYDVQQHDAhXYWxsZG9yZjEPMA0GA1UECgwGU0FQIFNFMRAwDgYDVQQLDAdDV0EgQ0xJMRAwDgYDVQQDDAdjd2EtY2xpMB4XDTIxMDcwOTA3NTM1NFoXDTMxMDcwNzA3NTM1NFowYjELMAkGA1UEBhMCREUxCzAJBgNVBAgMAkJXMREwDwYDVQQHDAhXYWxsZG9yZjEPMA0GA1UECgwGU0FQIFNFMRAwDgYDVQQLDAdDV0EgQ0xJMRAwDgYDVQQDDAdjd2EtY2xpMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEwje5dsNGZvGSkwA4jQg9UVCvh3CPct5+P8ohR8PMs7rGdL4tTWJi7lScy\\/IRbe6F74reDAuD3rsHAYQr\\/P+yaKMbMBkwFwYDVR0lBBAwDgYMKwYBBAEAjjePZQEBMAkGByqGSM49BAEDRwAwRAIgS5\\/I26TbsHfq5jPyl7HmStVhne0c8N7eceK8FRNdErUCIH78ryLy0S6cJsi0tW68ZyRKXk+wrtYUD0o6m\\/VLYfvP\"},{\"kid\":\"3seKUa2SxU0=\",\"data\":\"MIIB0jCCAXqgAwIBAgIJANGHZ6QEo1f4MAkGByqGSM49BAEwYjELMAkGA1UEBhMCREUxCzAJBgNVBAgMAkJXMREwDwYDVQQHDAhXYWxsZG9yZjEPMA0GA1UECgwGU0FQIFNFMRAwDgYDVQQLDAdDV0EgQ0xJMRAwDgYDVQQDDAdjd2EtY2xpMB4XDTIxMDcwOTA3NTM1NFoXDTMxMDcwNzA3NTM1NFowYjELMAkGA1UEBhMCREUxCzAJBgNVBAgMAkJXMREwDwYDVQQHDAhXYWxsZG9yZjEPMA0GA1UECgwGU0FQIFNFMRAwDgYDVQQLDAdDV0EgQ0xJMRAwDgYDVQQDDAdjd2EtY2xpMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEHFIf0ns15fni6clL7au4Hpz\\/t2DJ+4x\\/VC938tmmpI1SZPdSSpTOLex2kSgUkEX1ImkbvGUdCogoTadaYAosrqMaMBgwFgYDVR0lBA8wDQYLKwYBBAGON49lAQMwCQYHKoZIzj0EAQNHADBEAiB3NChh5Phull2OLqzbYHaXJXxdEmaS3MK4RFEdE\\/0JSwIgceg43yA1p\\/YhpuKf1LK2IyuowaTeQ47kGbkANhU\\/HqM=\"},{\"kid\":\"GEXba2UJLGM=\",\"data\":\"MIIB1DCCAXugAwIBAgIJANGHZ6QEo1f5MAkGByqGSM49BAEwYjELMAkGA1UEBhMCREUxCzAJBgNVBAgMAkJXMREwDwYDVQQHDAhXYWxsZG9yZjEPMA0GA1UECgwGU0FQIFNFMRAwDgYDVQQLDAdDV0EgQ0xJMRAwDgYDVQQDDAdjd2EtY2xpMB4XDTIxMDcwOTA3NTM1NFoXDTMxMDcwNzA3NTM1NFowYjELMAkGA1UEBhMCREUxCzAJBgNVBAgMAkJXMREwDwYDVQQHDAhXYWxsZG9yZjEPMA0GA1UECgwGU0FQIFNFMRAwDgYDVQQLDAdDV0EgQ0xJMRAwDgYDVQQDDAdjd2EtY2xpMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE5cShkP86pCwpKpD9GYDEhGsME5cZxpEOX7\\/aftsE8kjCGe4sjtNdOMjIufTSpH12r7S9pBU8jeI7TmtFIJWMdqMbMBkwFwYDVR0lBBAwDgYMKwYBBAEAjjePZQEDMAkGByqGSM49BAEDSAAwRQIhAJ+fltfFvOG5eal4wa+sv\\/gjZLKTXQcJnT2uJ9SbhqLWAiAchhP7v3i0inYSmB9LibRL\\/dCGfonVkk+pQsjGqgRjdg==\"},{\"kid\":\"hAeovR4V0yA=\",\"data\":\"MIICDDCCAbKgAwIBAgIJANGHZ6QEo1f7MAkGByqGSM49BAEwYjELMAkGA1UEBhMCREUxCzAJBgNVBAgMAkJXMREwDwYDVQQHDAhXYWxsZG9yZjEPMA0GA1UECgwGU0FQIFNFMRAwDgYDVQQLDAdDV0EgQ0xJMRAwDgYDVQQDDAdjd2EtY2xpMB4XDTIxMDcwOTEzMzY1NloXDTIxMDcxMDEzMzY1NlowYjELMAkGA1UEBhMCREUxCzAJBgNVBAgMAkJXMREwDwYDVQQHDAhXYWxsZG9yZjEPMA0GA1UECgwGU0FQIFNFMRAwDgYDVQQLDAdDV0EgQ0xJMRAwDgYDVQQDDAdjd2EtY2xpMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE4AX+nC5rHQd8VZbsATS+jO7LtLNZUs\\/Lo\\/YMw1\\/tb5si1xNHJel0DqiQj0rYf8ylPWq+4ghPcOrZr62e9yVwDaNSMFAwDgYDVR0PAQH\\/BAQDAgeAMB0GA1UdDgQWBBRpZH0bn2jUDNGU344Zi0gYSxBTTTAfBgNVHSMEGDAWgBS\\/hghB7Sqx\\/Z49r2OWQiJCveyCOTAJBgcqhkjOPQQBA0kAMEYCIQCro3URao1c+tnDrlII5bWQajXZl8bPKTDOZfG5IpAvfwIhAMv146\\/BKNIubPTJd6\\/PDZ+gyKiNp4j+UURF4AhD+EC9\"},{\"kid\":\"lVUg\\/FMSRV4=\",\"data\":\"MIICDTCCAbOgAwIBAgIJANGHZ6QEo1f6MAoGCCqGSM49BAMCMGIxCzAJBgNVBAYTAkRFMQswCQYDVQQIDAJCVzERMA8GA1UEBwwIV2FsbGRvcmYxDzANBgNVBAoMBlNBUCBTRTEQMA4GA1UECwwHQ1dBIENMSTEQMA4GA1UEAwwHY3dhLWNsaTAeFw0zMTAxMDQxMjA1NTJaFw00MTAxMDExMjA1NTJaMGIxCzAJBgNVBAYTAkRFMQswCQYDVQQIDAJCVzERMA8GA1UEBwwIV2FsbGRvcmYxDzANBgNVBAoMBlNBUCBTRTEQMA4GA1UECwwHQ1dBIENMSTEQMA4GA1UEAwwHY3dhLWNsaTBZMBMGByqGSM49AgEGCCqGSM49AwEHA0IABF8bD4R3pC5s4ISiCVkYrog\\/XYQJsMKDDaCE7whW18W4WMSBUN7mlI\\/s51KGmqUgCvzvgRUkO\\/iGunm+78h9gbujUjBQMA4GA1UdDwEB\\/wQEAwIHgDAdBgNVHQ4EFgQUU5XR6xDeZYZXRADfyqtvn7M5GfswHwYDVR0jBBgwFoAUv4YIQe0qsf2ePa9jlkIiQr3sgjkwCgYIKoZIzj0EAwIDSAAwRQIgHmxzZ7n4AilyGOQWdQ77qxbp6iM07s0BILsJAS+rvXMCIQChS6wzIV4iCOHC5uGBwZuk7MCyjS5i4PSLJyWN3zWeWg==\"}
    ]
    """
}
